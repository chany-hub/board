"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const introspectionQuery_1 = require("./introspectionQuery");
const graphqlClient_1 = require("./graphqlClient");
const schemaToQueries_1 = require("./schemaToQueries");
const coverageCalculator_1 = require("./coverageCalculator");
module.exports = function QueryGenerator(url) {
    function buildTypeDictionary(__schema) {
        let result = {};
        __schema.types.forEach(type => result[type.name] = type);
        return result;
    }
    this.run = function () {
        return graphqlClient_1.default(url, introspectionQuery_1.default)
            .then((res) => {
            if (!res.ok) {
                return res.text()
                    .then((responseText) => {
                    return Promise.reject(`Introspection query failed with status ${res.status}.\nResponse text:\n${responseText}`);
                });
            }
            return res.json();
        })
            .then(result => {
            const queryTypeName = result.data['__schema'].queryType.name;
            const typeDictionary = buildTypeDictionary(result.data['__schema']);
            const queries = schemaToQueries_1.default(queryTypeName, typeDictionary);
            const coverage = coverageCalculator_1.default(queryTypeName, typeDictionary);
            return { queries, coverage };
        });
    };
};
//# sourceMappingURL=queryGenerator.js.map